#!/bin/bash
export ARM_SAS_TOKEN_FILE="${CREDENTIALS_DIRECTORY}/azure/${ARM_STORAGE_ACCOUNT_NAME}.sas-token"

unset ARM_SAS_TOKEN_EXPIRATION

if [ -e "${ARM_SAS_TOKEN_FILE}" ]; then
  ARM_SAS_TOKEN_FILE_INFORMATION_DATE=$(stat -c "%y"  "${ARM_SAS_TOKEN_FILE}")
  ARM_SAS_TOKEN_FILE_INFORMATION_DATE_TIME=$(     echo ${ARM_SAS_TOKEN_FILE_INFORMATION_DATE} | awk -F '.' '{ print $1 }')
  ARM_SAS_TOKEN_FILE_INFORMATION_DATE_TIMEZONE=$( echo ${ARM_SAS_TOKEN_FILE_INFORMATION_DATE} | awk -F ' ' '{ print $3 }' | tr -d " ")
  export ARM_SAS_TOKEN_EXPIRATION="${ARM_SAS_TOKEN_FILE_INFORMATION_DATE_TIME} ${ARM_SAS_TOKEN_FILE_INFORMATION_DATE_TIMEZONE}"
fi

if ! [ -e "${ARM_SAS_TOKEN_FILE}" ]; then
  arm_sas_token_new > "${ARM_SAS_TOKEN_FILE}"
fi

export ARM_SAS_TOKEN=$(cat ${ARM_SAS_TOKEN_FILE})

if [ -n "${ARM_SAS_TOKEN}" ]; then
  export ARM_SAS_TOKEN_EXPIRATION="$(echo "${ARM_SAS_TOKEN:0:16}" | tr -d "\"se=" | tr "T" " "):00"
fi
