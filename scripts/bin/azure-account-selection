#!/bin/bash
SUBSCRIPTION_NAME="${1}"

if [[ -z "${SUBSCRIPTION_NAME}" ]]; then
  SUBSCRIPTION_NAME=$(az account list --query [].name --output tsv | fzf)
fi

az account set \
  --subscription "${SUBSCRIPTION_NAME}"

SUBSCRIPTION_ID=$(az account show \
  --output tsv \
  --query id)

TERNANT_ID=$(az account show \
  --output tsv \
  --query homeTenantId)

AZURE_CREDENTIALS_DIRECTORY="${CREDENTIALS_DIRECTORY?}/azure"
AZURE_CREDENTIALS_SUBSCRIPTION_FILE="${AZURE_CREDENTIALS_DIRECTORY?}/${SUBSCRIPTION_ID}.sh"
AZURE_CREDENTIALS_CURRENT_FILE="${AZURE_CREDENTIALS_DIRECTORY?}/current.sh"
AZURE_STORAGE_ACCOUNT_NAME="waspfoundation$(awk -F '-' '{ print $1 }' <<< "${SUBSCRIPTION_ID}")"

if [ ! -e "${AZURE_CREDENTIALS_SUBSCRIPTION_FILE}" ]; then
cat <<EOF > "${AZURE_CREDENTIALS_SUBSCRIPTION_FILE}"
export ARM_CLIENT_ID=SERVICE_PRINCIPAL_ID_HERE
export ARM_CLIENT_SECRET=SERVICE_PRINCIPAL_CLIENT_SECRET_HERE

export ARM_TENANT_ID=${TERNANT_ID}
export ARM_SUBSCRIPTION_ID=${SUBSCRIPTION_ID}
export ARM_SUBSCRIPTION_NAME=${SUBSCRIPTION_NAME}

export ARM_STORAGE_ACCOUNT_NAME=${AZURE_STORAGE_ACCOUNT_NAME}
export ARM_STORAGE_ACCOUNT_CONTAINER_NAME=terraform
EOF

chmod +x "${AZURE_CREDENTIALS_SUBSCRIPTION_FILE}"
fi

cp "${AZURE_CREDENTIALS_SUBSCRIPTION_FILE?}" "${AZURE_CREDENTIALS_CURRENT_FILE?}"

source "${AZURE_CREDENTIALS_CURRENT_FILE?}"

ARM_SAS_TOKEN_FILE="${CREDENTIALS_DIRECTORY?}/azure/${ARM_STORAGE_ACCOUNT_NAME?}.sas-token"

if [ ! -e "${ARM_SAS_TOKEN_FILE}" ]; then
  arm_sas_token >> "${AZURE_CREDENTIALS_CURRENT_FILE?}"
fi

echo "source ${AZURE_CREDENTIALS_CURRENT_FILE?}"
