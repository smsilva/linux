#!/bin/bash
selection() {
  az account set \
    --subscription "${SUBSCRIPTION_NAME}"

  SUBSCRIPTION_ID=$(az account show \
    --output tsv \
    --query id)

  TERNANT_ID=$(az account show \
    --output tsv \
    --query tenantId)

  AZURE_CREDENTIALS_DIRECTORY="${CREDENTIALS_DIRECTORY?}/azure"
  AZURE_CREDENTIALS_SUBSCRIPTION_FILE="${AZURE_CREDENTIALS_DIRECTORY?}/${SUBSCRIPTION_ID}"
  AZURE_CREDENTIALS_CURRENT_FILE="${AZURE_CREDENTIALS_DIRECTORY?}/current"
  AZURE_STORAGE_ACCOUNT_NAME="waspfoundation$(awk -F '-' '{ print $1 }' <<< "${SUBSCRIPTION_ID}")"
  AZURE_KEYVAULT_NAME="waspfoundation$(awk -F '-' '{ print $1 }' <<< "${SUBSCRIPTION_ID}")"

  if [ ! -e "${AZURE_CREDENTIALS_SUBSCRIPTION_FILE}" ]; then
    mkdir -p "${AZURE_CREDENTIALS_DIRECTORY}"

cat <<EOF > "${AZURE_CREDENTIALS_SUBSCRIPTION_FILE}"
export ARM_TENANT_ID="${TERNANT_ID}"
export ARM_SUBSCRIPTION_ID="${SUBSCRIPTION_ID}"
export ARM_SUBSCRIPTION_NAME="${SUBSCRIPTION_NAME}"

export ARM_CLIENT_ID="SERVICE_PRINCIPAL_ID_HERE"
export ARM_CLIENT_SECRET="SERVICE_PRINCIPAL_CLIENT_SECRET_HERE"

export ARM_STORAGE_ACCOUNT_NAME="${AZURE_STORAGE_ACCOUNT_NAME}"
export ARM_STORAGE_ACCOUNT_CONTAINER_NAME="terraform"

export ARM_KEYVAULT_NAME="${AZURE_KEYVAULT_NAME}"

unset ARM_ACCESS_KEY
EOF

    chmod +x "${AZURE_CREDENTIALS_SUBSCRIPTION_FILE}"
  fi

  cp "${AZURE_CREDENTIALS_SUBSCRIPTION_FILE?}" "${AZURE_CREDENTIALS_CURRENT_FILE?}"

  source "${AZURE_CREDENTIALS_CURRENT_FILE?}"

  source arm_sas_token_file
}

SUBSCRIPTION_NAME="${1}"

if [[ -z "${SUBSCRIPTION_NAME}" ]]; then
  SUBSCRIPTION_NAME="$(az account list --query [].name --output tsv | fzf)"

  if [ "$?" == "0" ]; then
    selection
  else
    exit 1
  fi
fi
