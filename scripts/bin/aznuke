#!/bin/bash
clear

AZURE_TENANT_ID_NUKE="${1-a267367d-d04d-4a6b-84ef-0cc227ed6e9f}"

JQ_EXPRESSION='.[] | select(.tentantId | contains("%s"))'

JQ_EXPRESSION="$(printf "${JQ_EXPRESSION}" "${AZURE_TENANT_ID_NUKE}")"

echo ""
echo "WARNING!!! WARNING!!! WARNING!!! WARNING!!!"
echo ""
echo "THIS IS A VERY DANGEROUS ACTION!!!"
echo ""
echo "ALL OF RESOURCE GROUPS UNDER TENTANT_ID: ${AZURE_TENANT_ID_NUKE} WILL BE COMPLETELY AND UNRECOVER DELETED."
echo ""
echo "DO IT FOR YOUR OWN RISK!!!"
echo ""

SUBSCRIPTIONS_SELECTED=$(az account list \
  --output tsv | grep "${AZURE_TENANT_ID_NUKE}" | wc -l)

if [ "${SUBSCRIPTIONS_SELECTED}" == "" ] || [ "${SUBSCRIPTIONS_SELECTED}" == "0" ]; then
  echo "There's no subscription selected."
  exit 1
fi

az account list \
  --output tsv \
  --query '[].{tenantId:tenantId,id:id,name:name}' | grep "${AZURE_TENANT_ID_NUKE}"

echo ""

read -r -p "Press any key to resume ..."

echo ""
echo ""

SUBSCRIPTION_LIST="$(az account list \
  --output tsv \
  --query '[].{tenantId:tenantId,id:id,name:name}' | grep "${AZURE_TENANT_ID_NUKE}")"

FILE_LOG_INFO="${HOME}/trash/aznuke/aznuke-info.log"
FILE_LOG_ERROR="${HOME}/trash/aznuke/aznuke-error.log"

while read -r LINE; do
  NUKE_TENANT_ID="$(awk '{ print $1 }' <<< "${LINE}")"
  NUKE_SUBSCRIPTION_ID="$(awk '{ print $2 }' <<< "${LINE}")"
  NUKE_SUBSCRIPTION_NAME="$(awk '{ print $3 }' <<< "${LINE}")"

  echo "NUKE_SUBSCRIPTION_NAME.: ${NUKE_SUBSCRIPTION_NAME}"
  echo "NUKE_SUBSCRIPTION_ID...: ${NUKE_SUBSCRIPTION_ID}"
  echo "NUKE_TENANT_ID.........: ${NUKE_TENANT_ID}"

  while read -r RESOURCE_GROUP_NAME; do
    if [ -n "${RESOURCE_GROUP_NAME}" ]; then
      echo "RESOURCE_GROUP_NAME....: ${RESOURCE_GROUP_NAME}"
  
      az group delete \
        --resource-group "${RESOURCE_GROUP_NAME}" \
        --subscription "${NUKE_SUBSCRIPTION_ID}" \
        --no-wait \
        --yes 1> >(tee -a "${FILE_LOG_INFO}") 2> >(tee -a "${FILE_LOG_ERROR}" >&2)
    fi
  done <<< "$(az group list \
    --subscription "${NUKE_SUBSCRIPTION_ID}" \
    --output tsv \
    --query '[].name' | grep -v iac)"

  echo ""
done <<< "${SUBSCRIPTION_LIST}"

list_groups() {
  while read -r LINE; do
    NUKE_TENANT_ID="$(awk '{ print $1 }' <<< "${LINE}")"
    NUKE_SUBSCRIPTION_ID="$(awk '{ print $2 }' <<< "${LINE}")"
    NUKE_SUBSCRIPTION_NAME="$(awk '{ print $3 }' <<< "${LINE}")"
     
    echo "${NUKE_SUBSCRIPTION_NAME} [${NUKE_SUBSCRIPTION_ID}]"
    echo ""

    az group list \
      --subscription "${NUKE_SUBSCRIPTION_ID}" \
      --output table

    echo ""
  done <<< "${SUBSCRIPTION_LIST}"
}

while true; do
  list_groups
  sleep 5

  clear
done
