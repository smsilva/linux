#!/bin/bash
CERTBOT_COMMAND_FILE="${HOME}/.certbot.bash"

show_usage() {
cat <<EOF

Usage:

  certificate \\
    --email certificates@silvios.me \\
    --domain sandbox.wasp.silvios.me \\
    --cname apps \\
    --cname services \\
    --cname demo

  certificate \\
    --email certificates@silvios.me \\
    --domain sandbox.wasp.silvios.me \\
    --cname "*"

  certificate \\
    --email certificates@silvios.me \\
    --domain sandbox.wasp.silvios.me \\
    --cname "*" \\
    --staging

EOF
}

CNAMES=""

while [[ -n "${1}" ]]; do case ${1} in
  --domain )
    DOMAIN=${2}
    shift;
    ;;

  --email )
    CERTBOT_NOTIFICATION_EMAIL=${2}
    shift;
    ;;

  --cname )
    CNAMES="${CNAMES} ${2}"
    shift;
    ;;

  --staging )
    SERVER="acme-staging-v02"
    ;;
esac; shift; done
if [[ "${1}" == '--' ]]; then shift; fi

SERVER=${SERVER-acme-v02}
CERTBOT_ACME_SERVER="${CERTBOT_ACME_SERVER-https://${SERVER?}.api.letsencrypt.org/directory}"

if [ -z "${DOMAIN}"                     ] || \
   [ -z "${DOMAIN}"                     ] || \
   [ -z "${CERTBOT_NOTIFICATION_EMAIL}" ]; then
  show_usage
  exit 1
fi

cat <<EOF > "${CERTBOT_COMMAND_FILE}"
certbot certonly \\
  --manual \\
  --preferred-challenges dns \\
  --agree-tos \\
  --email "${CERTBOT_NOTIFICATION_EMAIL}" \\
  --no-eff-email \\
  --server "${CERTBOT_ACME_SERVER}" \\
  --config-dir "\${HOME}/certificates/config" \\
  --work-dir "\${HOME}/certificates/work" \\
  --logs-dir "\${HOME}/certificates/logs" \\
EOF

while read -r CNAME; do
  if [ -n "${CNAME}" ]; then
    echo "  -d ${CNAME}.${DOMAIN}" >> "${CERTBOT_COMMAND_FILE}"
  fi
done <<< "$(echo "${CNAMES}" | tr " " "\n")"

echo "" >> "${CERTBOT_COMMAND_FILE}"

echo ""

cat "${CERTBOT_COMMAND_FILE}"

exit 0

openssl pkcs12 \
  -export \
  -inkey "certificate.key.pem" \
  -in    "fullchain.pem" \
  -out   "certificate-combined.pfx"

openssl pkcs12 \
  -in "certificate-combined.pfx" \
  -info

openssl x509 \
  -in "cert1.pem" \
  -noout \
  -text
